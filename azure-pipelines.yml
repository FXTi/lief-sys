jobs:
  - template: default.yml@templates
    parameters:
      minrust: false
      #codecov_token: $(CODECOV_TOKEN)
      setup:
        - script: |
            $header = "AUTHORIZATION: bearer $(System.AccessToken)"
            git -c http.extraheader="$header" submodule sync
            git -c http.extraheader="$header" submodule update --init --force --depth=1
          displayName: "Checkout recursively"
        - script: |
            choco install ninja
          condition: eq(variables['Agent.OS'], 'Windows_NT')
          displayName: "Install Ninja(Windows)"
        - script: |
            brew install ninja
          condition: eq(variables['Agent.OS'], 'Darwin')
          displayName: "Install Ninja(MacOS)"
        - script: |
            sudo apt-get install ninja-build
          condition: eq(variables['Agent.OS'], 'Linux')
          displayName: "Install Ninja(Linux)"
  - job: tarpaulin
    pool:
      vmImage: ubuntu-18.04
    displayName: tarpaulin
    steps:
      - script: |
          $header = "AUTHORIZATION: bearer $(System.AccessToken)"
          git -c http.extraheader="$header" submodule sync
          git -c http.extraheader="$header" submodule update --init --force --depth=1
        displayName: "Checkout recursively"
      - bash: |
          set -ex
          sudo docker run -v $PWD:/t --security-opt seccomp=unconfined xd009642/tarpaulin:latest /bin/bash -c "set -ex; cd /t; apt update; apt install -y llvm-dev libclang-dev clang cmake ninja-build; cargo tarpaulin --out Xml; CODECOV_TOKEN=$(CODECOV_TOKEN) bash <(curl -s https://codecov.io/bash);"
        displayName: "Run tarpaulin"

resources:
  repositories:
    - repository: templates
      type: github
      name: crate-ci/azure-pipelines
      ref: refs/heads/v0.4
      endpoint: FXTi